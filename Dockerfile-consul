# Use the official Consul image
FROM hashicorp/consul:1.19.0
# Add consul.hcl configuration file
COPY ./consul-conf/consul.hcl /consul/config/consul.hcl
COPY ./node-local-kali.tailc2844.ts.net.crt /certs/ca.crt
# Add the JWT provider and service intentions configuration files
COPY ./consul-conf/policy.hcl /consul/policy.hcl

# Add a script to configure Consul after it starts
COPY ./consul-conf/configure-consul.sh /usr/local/bin/configure-consul.sh

# Make the script executable
RUN chmod +x /usr/local/bin/configure-consul.sh

# Start Consul and run the configuration script
#CMD ["sh", "-c", "consul agent -dev -config-dir=/consul/config & sleep 10 && /usr/local/bin/configure-consul.sh"]
CMD ["sh", "-c","/usr/local/bin/configure-consul.sh & consul agent -dev -config-dir=/consul/config -log-level trace"]
